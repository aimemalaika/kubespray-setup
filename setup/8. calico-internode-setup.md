# üìù Troubleshooting and Fixing Inter-Node Pod Connectivity with Calico (Kubespray)

## 1. Problem Statement

* Pods on the **same node** could communicate with each other.
* Pods on **different nodes** could **not** reach each other.
* Example:

  * ‚úÖ `pod-a` ‚Üí `pod-b` (same node) worked.
  * ‚ùå `pod-a` ‚Üí `pod-c` (different node) failed.

This indicated that **inter-node pod networking was broken**.

---

## 2. Root Cause

* Calico was deployed via Kubespray with **VXLAN disabled**:

  * `CALICO_IPV4POOL_VXLAN=Never`
  * `CALICO_IPV4POOL_IPIP=Off`
* The default IPPool also had:

  ```yaml
  ipipMode: Never
  vxlanMode: Never
  ```
* This meant **no encapsulation was being used**, so pods on different nodes had no routable paths unless native L3 routing was configured between pod subnets (which wasn‚Äôt the case).

---

## 3. Verification Steps

* Checked pod routes on worker nodes:

  ```bash
  ip route | grep 10.233.
  ```

  Only local pod IPs were present, no working cross-node routes.
* Verified Calico DaemonSet environment:

  ```bash
  kubectl -n kube-system get ds calico-node -o yaml | grep -i 'VXLAN\|IPIP'
  ```

  Showed VXLAN set to `Never`.
* Confirmed `calico-config` ConfigMap had `calico_backend: bird` instead of VXLAN.

---

## 4. The Fix

### Step 1 ‚Äî Switch Calico to VXLAN Encapsulation

Updated the configuration:

* Set in `calico-config`:

  ```yaml
  calico_backend: vxlan
  ```
* Patched the IPPool:

  ```bash
  kubectl patch ippools.crd.projectcalico.org default-pool \
    --type merge -p '{"spec":{"vxlanMode":"Always","ipipMode":"Never"}}'
  ```

### Step 2 ‚Äî Redeploy Calico DaemonSet

Rolled out Calico with the new config:

```bash
kubectl -n kube-system rollout restart ds calico-node
kubectl -n kube-system rollout status ds calico-node
```

---

## 5. Validation

* Launched test pods on **different nodes**:

  ```bash
  kubectl run pod-a --image=busybox:1.35 --restart=Never -- sleep 3600
  kubectl run pod-c --image=busybox:1.35 --restart=Never -- sleep 3600
  ```
* Checked connectivity:

  ```bash
  kubectl exec -it pod-a -- ping -c3 <pod-c-IP>
  ```

  ‚úÖ Success ‚Äî pods on different nodes could now communicate.

---

## 6. Lessons Learned

* **Calico Encapsulation Modes**:

  * `vxlanMode: Always` ‚Üí encapsulates pod-to-pod traffic between nodes using VXLAN overlay (safe default).
  * `ipipMode: Always` ‚Üí alternative encapsulation (used in some environments).
  * `Never` ‚Üí only works if your underlay network routes all pod subnets (not the case here).
* In Kubespray:

  * Ensure `calico_vxlan_mode: 'Always'` is set in your cluster vars if your network does not natively route pod subnets.

---

‚úÖ **Final State**:
Pods across worker and control plane nodes can now communicate seamlessly through VXLAN encapsulation managed by Calico
